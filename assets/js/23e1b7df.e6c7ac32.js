"use strict";(self.webpackChunksmooth=self.webpackChunksmooth||[]).push([[4497],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>h});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var p=r.createContext({}),s=function(e){var t=r.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=s(e.components);return r.createElement(p.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,p=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),m=s(n),h=a,u=m["".concat(p,".").concat(h)]||m[h]||c[h]||i;return n?r.createElement(u,o(o({ref:t},d),{},{components:n})):r.createElement(u,o({ref:t},d))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=m;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var s=2;s<i;s++)o[s]=n[s];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},1255:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>o,default:()=>c,frontMatter:()=>i,metadata:()=>l,toc:()=>s});var r=n(7462),a=(n(7294),n(3905));const i={},o="What to do",l={unversionedId:"design/infra/preempt/what-low",id:"design/infra/preempt/what-low",title:"What to do",description:"Abstractly speaking, we should produce a new UI when doing a preempt. For example, when showing enter-page animation, the new UI will be a screen shifting pixel by pixel as time goes by.",source:"@site/docs/design/infra/preempt/what-low.md",sourceDirName:"design/infra/preempt",slug:"/design/infra/preempt/what-low",permalink:"/flutter_smooth/design/infra/preempt/what-low",draft:!1,editUrl:"https://github.com/fzyzcjy/flutter_smooth/tree/master/website/docs/design/infra/preempt/what-low.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"When to trigger",permalink:"/flutter_smooth/design/infra/preempt/when"},next:{title:"PreemptBuilder",permalink:"/flutter_smooth/design/infra/preempt/what-high"}},p={},s=[{value:"How to create <code>Scene</code>",id:"how-to-create-scene",level:2}],d={toc:s};function c(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"what-to-do"},"What to do"),(0,a.kt)("p",null,"Abstractly speaking, we should produce a new UI when doing a preempt. For example, when showing enter-page animation, the new UI will be a screen shifting pixel by pixel as time goes by."),(0,a.kt)("p",null,"More concretely, what is the new UI? This needs some background of Flutter internal implementation. The UI that the ui thread submits to rasterizer thread is indeed a ",(0,a.kt)("inlineCode",{parentName:"p"},"Scene")," object, and it is submitted to rasterizer via ",(0,a.kt)("inlineCode",{parentName:"p"},"window.render"),"."),(0,a.kt)("h2",{id:"how-to-create-scene"},"How to create ",(0,a.kt)("inlineCode",{parentName:"h2"},"Scene")),(0,a.kt)("p",null,"So how can we create the latest UI inside the preempt render? Let's firstly discuss the lowest-level approach, and below we will provide a wrapper so users can create widgets easily."),(0,a.kt)("p",null,"Recall how Flutter is implemented. During a normal frame pipeline, the build and layout phase modifies ",(0,a.kt)("inlineCode",{parentName:"p"},"RenderObject")," (and other things), while the ",(0,a.kt)("inlineCode",{parentName:"p"},"Layer")," tree is untouched and is still old (i.e. has content from last frame). During the paint phase, ",(0,a.kt)("inlineCode",{parentName:"p"},"RenderObject")," will modify the ",(0,a.kt)("inlineCode",{parentName:"p"},"Layer")," tree by utilizing its new data. Finally, the ",(0,a.kt)("inlineCode",{parentName:"p"},"Scene")," is built from the ",(0,a.kt)("inlineCode",{parentName:"p"},"Layer")," tree, and submitted to rasterizer via ",(0,a.kt)("inlineCode",{parentName:"p"},"window.render"),"."),(0,a.kt)("p",null,"Recall the preempt render is called ",(0,a.kt)("em",{parentName:"p"},"inside")," the build or layout phase. Therefore, during a preempt render, we have dirty ",(0,a.kt)("inlineCode",{parentName:"p"},"RenderObject")," tree and should not utilize it. However, the ",(0,a.kt)("inlineCode",{parentName:"p"},"Layer")," tree is, foruntately, non-dirty and ready to be used, with content generated from the plain-old rendering in the ",(0,a.kt)("em",{parentName:"p"},"last")," frame."),(0,a.kt)("p",null,"Now consider what happens during a preempt render. For simplicity, suppose we are doing a page-enter animation, and the widget handling page shifting is bound to a specific ",(0,a.kt)("inlineCode",{parentName:"p"},"OffsetLayer"),". Then, inside preempt render, we simply do something like ",(0,a.kt)("inlineCode",{parentName:"p"},"thatOffsetLayer.offset += 10px"),". By doing so, the UI will have the new page shifted a bit, i.e. the animation progresses a bit. After that, we can submit the whole layer tree object to rasterizer (indeed convert to ",(0,a.kt)("inlineCode",{parentName:"p"},"Scene")," and call ",(0,a.kt)("inlineCode",{parentName:"p"},"window.render"),")."),(0,a.kt)("p",null,"Thus, we now have a mechanism for 60FPS smooth animation, no matter how heavy the tree is to build/layout."),(0,a.kt)("p",null,"Pseudo-code is like this:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-dart"},"void preemptRender() {\n  flutterMainLayerTree.thatOffsetLayer.offset += 10px;\n  window.render(buildScene(flutterMainLayerTree));\n}\n")),(0,a.kt)("p",null,"No worries, this is not the end - see next section for how we make it developer friendly."))}c.isMDXComponent=!0}}]);