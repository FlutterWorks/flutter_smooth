"use strict";(self.webpackChunksmooth=self.webpackChunksmooth||[]).push([[1783],{3905:(e,t,r)=>{r.d(t,{Zo:()=>c,kt:()=>d});var n=r(7294);function i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function a(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function o(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?a(Object(r),!0).forEach((function(t){i(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function s(e,t){if(null==e)return{};var r,n,i=function(e,t){if(null==e)return{};var r,n,i={},a=Object.keys(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||(i[r]=e[r]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}var p=n.createContext({}),l=function(e){var t=n.useContext(p),r=t;return e&&(r="function"==typeof e?e(t):o(o({},t),e)),r},c=function(e){var t=l(e.components);return n.createElement(p.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var r=e.components,i=e.mdxType,a=e.originalType,p=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),m=l(r),d=i,h=m["".concat(p,".").concat(d)]||m[d]||u[d]||a;return r?n.createElement(h,o(o({ref:t},c),{},{components:r})):n.createElement(h,o({ref:t},c))}));function d(e,t){var r=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var a=r.length,o=new Array(a);o[0]=m;var s={};for(var p in t)hasOwnProperty.call(t,p)&&(s[p]=t[p]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var l=2;l<a;l++)o[l]=r[l];return n.createElement.apply(null,o)}return n.createElement.apply(null,r)}m.displayName="MDXCreateElement"},2447:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>p,contentTitle:()=>o,default:()=>u,frontMatter:()=>a,metadata:()=>s,toc:()=>l});var n=r(7462),i=(r(7294),r(3905));const a={},o="Pointer dispatch speed-up",s={unversionedId:"design/infra/misc/pointer-dispatch",id:"design/infra/misc/pointer-dispatch",title:"Pointer dispatch speed-up",description:"Title: Speed up pointer data packet dispatching by roughly 2x when multiple packets come",source:"@site/docs/design/infra/misc/pointer-dispatch.md",sourceDirName:"design/infra/misc",slug:"/design/infra/misc/pointer-dispatch",permalink:"/flutter_smooth/design/infra/misc/pointer-dispatch",draft:!1,editUrl:"https://github.com/fzyzcjy/flutter_smooth/tree/master/website/docs/design/infra/misc/pointer-dispatch.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Fix rasterizer ending time",permalink:"/flutter_smooth/design/infra/misc/rasterizer-ending"},next:{title:"Report timing slowness",permalink:"/flutter_smooth/design/infra/misc/report-timing"}},p={},l=[{value:"Benefits for Flutter (without considering flutter_smooth)",id:"benefits-for-flutter-without-considering-flutter_smooth",level:2},{value:"Benefits for flutter_smooth",id:"benefits-for-flutter_smooth",level:2}],c={toc:l};function u(e){let{components:t,...r}=e;return(0,i.kt)("wrapper",(0,n.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"pointer-dispatch-speed-up"},"Pointer dispatch speed-up"),(0,i.kt)("admonition",{type:"info"},(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("strong",{parentName:"p"},"Title"),": Speed up pointer data packet dispatching by roughly 2x when multiple packets come"),(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("strong",{parentName:"p"},"Link"),": ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/flutter/engine/pull/36826"},"https://github.com/flutter/engine/pull/36826"))),(0,i.kt)("h2",{id:"benefits-for-flutter-without-considering-flutter_smooth"},"Benefits for Flutter (without considering flutter_smooth)"),(0,i.kt)("p",null,"Multiple pointer data packets often arrive in one vsync interval. Currently, each of them requires a PostTask, C++-to-Dart-call, etc. However, when there is already one ",(0,i.kt)("em",{parentName:"p"},"pending")," PostTask and a second data packet arrives, we can optimize it - no need to schedule a second PostTask and C++-to-Dart call, but instead utilize the pending PostTask and submit more data inside one call."),(0,i.kt)("p",null,"How much speed up does it give: Consider the following screenshot (It happens after a long janky frame, but serves pretty well for us to compute numbers because it contains a lot of items - the average measure error will be much smaller). As we can see,"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"total wall time: ~8.2ms"),(0,i.kt)("li",{parentName:"ul"},"total Dart time (measured by the ",(0,i.kt)("inlineCode",{parentName:"li"},"_handlePointerDataPacket")," time, which is the 4th purple row. I made an extra Timeline event to measure that): ~3.2ms")),(0,i.kt)("p",null,"Therefore, if we merge multiple into one, we can get roughly 2x speed up, because it removes those idle periods between them, as well as some of the big overhead between Engine::DispatchPointerDataPacket and the real Dart code execution."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://user-images.githubusercontent.com/5236035/196432743-3e1c59b0-29d8-4139-9134-25e361785515.png",alt:"image"}),"\n",(0,i.kt)("img",{parentName:"p",src:"https://user-images.githubusercontent.com/5236035/196433392-c76ed644-4df1-4d5d-82ab-4eea9ed3a0ed.png",alt:"image"})),(0,i.kt)("p",null,"Concrete cases when this happens:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"When it janks, this PR helps speed up. For example, many Android devices provide two data packets per vsync interval. So suppose somehow the UI thread took 30ms to compute a frame, then this approach will merge 3-4 packet deliver into one."),(0,i.kt)("li",{parentName:"ol"},"In some devices, speedup due to this PR happens in each and every time. For example, below is a tracing on a test phone. As you can see, it delivers 4 pointer data packets per frame. Consider what will happen when UI thread needs (e.g.) 15ms to compute (unlike what is in the screenshot which is very lightweight workload indeed). Then, the first 3 out of 4 packets will be able to be merged by this PR.")),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://user-images.githubusercontent.com/5236035/196432383-79921b20-791e-4b51-b3a7-14e671bfea41.png",alt:"image"})),(0,i.kt)("h2",{id:"benefits-for-flutter_smooth"},"Benefits for flutter_smooth"),(0,i.kt)("p",null,"The analysis is similar to above. However, since there are a lot of big janky frames in flutter_smooth, it is common to see a dozen of pointer event dispatching after that long janky frame. Therefore, this PR makes that part much much faster."))}u.isMDXComponent=!0}}]);